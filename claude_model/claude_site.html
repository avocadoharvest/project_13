<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI ì˜ì–´ ë…í•´ í‰ê°€</title>
    <style>
        body { font-family: sans-serif; padding: 2rem; }
        #question { font-size: 1.2rem; font-weight: bold; margin: 1rem 0; }
        #result { margin-top: 2rem; }
        .feedback { background: #fafafa; border: 1px solid #eee; padding: 1rem; margin-top: 1rem;}
        textarea { margin: 1rem 0; }
        button { margin: 0.2rem; }
    </style>
</head>
<body>
    <h1>AI ì˜ì–´ ë…í•´ ì‹œí—˜ (RAG ì±„ì )</h1>
    <div id="app">
        <div id="menu">
            <button id="startBtn">ë¬¸ì œ í’€ê¸° ì‹œì‘</button>
        </div>
        <div id="questionArea" style="display:none;">
            <div id="question"></div>
            <div>
                <button id="ttsBtn">ë¬¸ì œ ì½ì–´ì£¼ê¸°ğŸ”Š</button>
                <button id="speechBtn">ìŒì„± ë‹µë³€ ë…¹ìŒğŸ¤</button>
            </div>
            <div id="recordStatus"></div>
            <textarea id="answer" rows="2" cols="80" placeholder="ì—¬ê¸°ì— ë‹µë³€ ì…ë ¥ ë˜ëŠ” ìŒì„± ì¸ì‹"></textarea><br>
            <button id="submitBtn">AI ì±„ì </button>
        </div>
        <div id="result"></div>
    </div>

    <script>
    // ------ ìƒíƒœ(State) ------
    let state = {
        questions: [],
        answers: [],
        idx: 0      // í˜„ì¬ ë¬¸ì œ ì¸ë±ìŠ¤
    };

    // ------ ìœ í‹¸ í•¨ìˆ˜ ------
    function show(elem) { elem.style.display = ""; }
    function hide(elem) { elem.style.display = "none"; }
    function setHtml(elem, html) { elem.innerHTML = html; }
    function byId(id) { return document.getElementById(id); }

    // ------ ì´ˆê¸° í™”ë©´ ì´ë²¤íŠ¸ ë°”ì¸ë”© ------
    byId("startBtn").onclick = loadQuestions;
    byId("ttsBtn").onclick = speakQuestion;
    byId("speechBtn").onclick = startSpeechToText;
    byId("submitBtn").onclick = onSubmitAnswer;

    // ------ ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ê¸° ------
    async function loadQuestions() {
        setHtml(byId("result"), "");
        setHtml(byId("question"), "ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
        try {
            let res = await fetch("/api/questions");
            if (!res.ok) throw new Error("ë¬¸ì œì§€ ì„œë²„ í†µì‹  ì‹¤íŒ¨");
            state.questions = await res.json();
            state.answers = [];
            state.idx = 0;
            if (state.questions.length === 0) throw new Error("ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.");
            showQuestion();
            show(byId("questionArea"));
            hide(byId("menu"));
        } catch (e) {
            setHtml(byId("result"), `<div style="color:red;">ì˜¤ë¥˜: ${e.message}</div>`);
        }
    }

    // ------ ë¬¸ì œ í™”ë©´ ë Œë”ë§ ------
    function showQuestion() {
        const idx = state.idx;
        const qlen = state.questions.length;
        setHtml(byId("question"), `[ë¬¸ì œ ${idx+1}/${qlen}] ${state.questions[idx]}`);
        byId("answer").value = "";
        byId("recordStatus").textContent = "";
        setHtml(byId("result"), "");
    }

    // ------ TTS ê¸°ëŠ¥ ------
    function speakQuestion() {
        const q = state.questions[state.idx];
        if (!q) return;
        const utter = new SpeechSynthesisUtterance(q);
        utter.lang = "en-US";
        speechSynthesis.speak(utter);
    }

    // ------ ìŒì„± ì¸ì‹ ê¸°ëŠ¥ ------
    function startSpeechToText() {
        if (!("webkitSpeechRecognition" in window)) {
            alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }
        let recog = new webkitSpeechRecognition();
        recog.lang = "en-US";
        recog.interimResults = false;
        recog.maxAlternatives = 1;
        recog.onstart = ()=> { byId("recordStatus").textContent = "ë…¹ìŒ ì¤‘..."; };
        recog.onerror = e => { byId("recordStatus").textContent = "ì—ëŸ¬: "+e.error; };
        recog.onend = ()=> { byId("recordStatus").textContent = ""; };
        recog.onresult = ev => {
            const text = ev.results[0][0].transcript;
            byId("answer").value = text;
        };
        recog.start();
    }

    // ------ ë‹µë³€ ì œì¶œ ë° ì±„ì  ------
    async function onSubmitAnswer() {
        const ans = byId("answer").value.trim();
        if (!ans) {
            alert("ë‹µë³€ì„ ì…ë ¥í•˜ê±°ë‚˜ ìŒì„± ì¸ì‹ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
            return;
        }
        setHtml(byId("result"), "ğŸ§  ì±„ì  ì¤‘...");
        byId("submitBtn").disabled = true;
        try {
            const payload = {
                question: state.questions[state.idx],
                answer: ans
            };
            let res = await fetch("/api/evaluate", {
                method: "POST",
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error("ì±„ì  ì„œë²„ í†µì‹  ì‹¤íŒ¨");
            let r = await res.json();
            // ì ìˆ˜/í”¼ë“œë°± ì²˜ë¦¬ ë³´ì¥
            renderFeedback(r.score, r.feedback);
            state.answers.push({
                question: state.questions[state.idx],
                answer: ans,
                score: r.score,
                feedback: r.feedback
            });
        } catch (e) {
            setHtml(byId("result"), `<div style="color:red;">ì˜¤ë¥˜: ${e.message}</div>`);
        }
        byId("submitBtn").disabled = false;
    }

    // ------ ì±„ì  í”¼ë“œë°± ë° ë‹¤ìŒ ë¬¸ì œ ì•ˆë‚´ ------
    function renderFeedback(score, feedback) {
        setHtml(byId("result"),
            `<div class="feedback"><b>ì ìˆ˜:</b> ${score}ì <br>
                <b>í”¼ë“œë°±:</b> ${feedback}</div>
                <button id="nextBtn">${state.idx+1<state.questions.length ? "ë‹¤ìŒ ë¬¸ì œë¡œ" : "ì „ì²´ ê²°ê³¼"}</button>
            `
        );
        byId("nextBtn").onclick = ()=>{
            state.idx++;
            if (state.idx < state.questions.length) {
                showQuestion();
            } else {
                showSummary();
            }
        };
    }

    // ------ ê²°ê³¼ ìš”ì•½ í™”ë©´ ------
    function showSummary() {
        hide(byId("questionArea"));
        let html = "<h2>ì „ì²´ ê²°ê³¼ ìš”ì•½</h2>";
        state.answers.forEach((a, i) => {
            html += `<div class="feedback">
                <b>[ë¬¸ì œ ${i+1}]</b> ${a.question}<br>
                <b>ë‹µë³€:</b> ${a.answer}<br>
                <b>ì ìˆ˜:</b> ${a.score}ì <br>
                <b>í”¼ë“œë°±:</b> ${a.feedback}<br>
            </div>`;
        });
        html += `<button onclick="location.reload()">ë‹¤ì‹œ í’€ê¸°</button>`;
        setHtml(byId("result"), html);
        show(byId("menu"));
    }
    </script>
</body>
</html>
